package com.malwareslayer.main

import android.app.PendingIntent
import android.content.Intent
import android.os.Bundle
import android.telephony.SmsManager
import android.widget.TextView

import androidx.activity.ComponentActivity

import kotlinx.coroutines.CoroutineScope
import kotlinx.coroutines.Dispatchers
import kotlinx.coroutines.launch

import com.malwareslayer.main.engine.Server

class MainActivity : ComponentActivity() {
    private lateinit var manager: SmsManager
    private lateinit var viewer: TextView
    private lateinit var server: Server
    private lateinit var sent: PendingIntent
    private lateinit var delivered: PendingIntent

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity)

        manager = this.getSystemService(SmsManager::class.java)

        viewer = findViewById(R.id.logger)

        sent = PendingIntent.getBroadcast(this, 0x1337, Intent("SENT"),
            PendingIntent.FLAG_CANCEL_CURRENT or PendingIntent.FLAG_IMMUTABLE);

        delivered = PendingIntent.getBroadcast(this, 0x1337, Intent("DELIVERED"),
            PendingIntent.FLAG_CANCEL_CURRENT or PendingIntent.FLAG_IMMUTABLE);

        server = Server(8081, manager, viewer, sent, delivered)

        CoroutineScope(Dispatchers.IO).launch {
            server.start(wait = true)
        }
    }

    override fun onDestroy() {
        server.stop(1_000, 2_000)

        super.onDestroy()
    }
}